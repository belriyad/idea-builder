name: Deploy to Test Environment

on:
  push:
    branches:
      - 'copilot/**'  # Deploy on push to copilot branches
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allow manual deployment

env:
  NODE_VERSION: '18.x'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        env:
          NODE_ENV: test
          JWT_SECRET: test-jwt-secret-for-ci

      - name: Upload test coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for vulnerabilities
        run: npm audit --production
        continue-on-error: true

      - name: Build application
        run: |
          echo "Application ready for deployment"
          echo "Build timestamp: $(date)" > build-info.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            src/
            public/
            package.json
            package-lock.json
            build-info.txt

  deploy-docker:
    name: Deploy with Docker (Option 1)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t idea-builder:test \
            --build-arg NODE_ENV=test \
            -f Dockerfile .
        continue-on-error: true

      - name: Test Docker image
        run: |
          docker run -d -p 3000:3000 \
            -e JWT_SECRET=test-secret \
            -e NODE_ENV=test \
            --name idea-builder-test \
            idea-builder:test
          sleep 5
          curl -f http://localhost:3000/health || exit 1
          docker stop idea-builder-test
        continue-on-error: true

  deploy-heroku:
    name: Deploy to Heroku (Option 2)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          healthcheck: "https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com/health"
          delay: 5
        continue-on-error: true

  deploy-vps:
    name: Deploy to VPS (Option 3)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # Navigate to application directory
            cd /var/www/idea-builder-test || exit 1
            
            # Pull latest changes
            git pull origin ${{ github.ref_name }}
            
            # Install dependencies
            npm ci
            
            # Set environment variables
            export NODE_ENV=test
            export JWT_SECRET="${{ secrets.TEST_JWT_SECRET }}"
            export PORT=3000
            
            # Restart application with PM2
            pm2 restart idea-builder-test || pm2 start src/server.js --name idea-builder-test
            
            # Wait for app to start
            sleep 5
            
            # Health check
            curl -f http://localhost:3000/health || exit 1
            
            echo "Deployment successful!"
        continue-on-error: true

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tests:** ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Options" >> $GITHUB_STEP_SUMMARY
          echo "To deploy to test environment, run this workflow manually (workflow_dispatch) or configure secrets for your preferred platform:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker**: Builds and tests containerized version" >> $GITHUB_STEP_SUMMARY
          echo "- **Heroku**: Requires HEROKU_API_KEY, HEROKU_APP_NAME, HEROKU_EMAIL" >> $GITHUB_STEP_SUMMARY
          echo "- **VPS**: Requires VPS_HOST, VPS_USERNAME, VPS_SSH_KEY, TEST_JWT_SECRET" >> $GITHUB_STEP_SUMMARY
